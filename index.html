<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClosedCircle</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; color: #222; }

  #auth { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #fff; }
  .auth-box { width: 300px; text-align: center; }
  .auth-box h1 { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
  .auth-box p { color: #aaa; font-size: 13px; margin-bottom: 24px; }
  .auth-box input { width: 100%; padding: 10px 12px; border: 1.5px solid #e0e0e0; border-radius: 8px; font-size: 14px; margin-bottom: 8px; outline: none; }
  .auth-box input:focus { border-color: #222; }
  .auth-box button { width: 100%; padding: 10px; background: #222; color: #fff; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; }
  .auth-box button:hover { background: #444; }
  .auth-error { color: #e00; font-size: 12px; margin-top: 6px; min-height: 16px; }

  #app { display: none; max-width: 560px; margin: 0 auto; padding: 16px 12px 60px; }

  .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
  .header h1 { font-size: 18px; font-weight: 700; }
  .header-right { display: flex; align-items: center; gap: 8px; }
  .username-badge { font-size: 12px; background: #f0f0f0; padding: 4px 9px; border-radius: 20px; }
  .logout-btn { font-size: 12px; color: #aaa; background: none; border: none; cursor: pointer; }
  .logout-btn:hover { color: #222; }

  .create-post { background: #fff; border-radius: 10px; padding: 12px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.06); }
  .create-post textarea { width: 100%; border: none; outline: none; font-size: 14px; resize: none; font-family: inherit; min-height: 56px; color: #222; }
  .create-post textarea::placeholder { color: #bbb; }

  .media-preview { margin: 8px 0; position: relative; }
  .media-preview img { width: 100%; max-height: 260px; object-fit: cover; border-radius: 8px; display: block; }
  .remove-media { position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,.45); color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 15px; display: flex; align-items: center; justify-content: center; }

  .post-actions { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
  .upload-btn { display: flex; align-items: center; gap: 5px; padding: 6px 12px; background: #f5f5f5; border: none; border-radius: 7px; font-size: 13px; cursor: pointer; color: #555; }
  .upload-btn:hover { background: #eee; }
  .upload-btn input { display: none; }
  .spacer { flex: 1; }
  .post-btn { padding: 6px 16px; background: #222; color: #fff; border: none; border-radius: 7px; font-size: 13px; cursor: pointer; }
  .post-btn:hover { background: #444; }
  .post-btn:disabled { background: #bbb; cursor: not-allowed; }

  .uploading-bar { margin-top: 6px; font-size: 12px; color: #888; display: none; align-items: center; gap: 6px; }
  .spinner { width: 12px; height: 12px; border: 2px solid #ddd; border-top-color: #222; border-radius: 50%; animation: spin .6s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .feed { display: flex; flex-direction: column; gap: 10px; }
  .post-card { background: #fff; border-radius: 10px; padding: 14px; box-shadow: 0 1px 2px rgba(0,0,0,.06); }
  .post-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
  .avatar { width: 32px; height: 32px; border-radius: 50%; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; flex-shrink: 0; }
  .post-meta { flex: 1; }
  .post-author { font-weight: 600; font-size: 13px; }
  .post-time { font-size: 11px; color: #bbb; }
  .post-text { font-size: 14px; line-height: 1.5; margin-bottom: 10px; white-space: pre-wrap; word-break: break-word; }
  .post-media { margin-bottom: 10px; }
  .post-media img { width: 100%; display: block; max-height: 380px; object-fit: cover; border-radius: 8px; cursor: pointer; }
  .post-media iframe { width: 100%; height: 280px; border: none; border-radius: 8px; }
  .post-footer { display: flex; align-items: center; gap: 10px; }
  .like-btn, .comment-toggle { display: flex; align-items: center; gap: 4px; background: none; border: none; cursor: pointer; font-size: 13px; color: #aaa; padding: 3px 7px; border-radius: 7px; }
  .like-btn:hover, .comment-toggle:hover { background: #f5f5f5; color: #666; }
  .like-btn.liked { color: #e00; }

  .comments-section { margin-top: 10px; border-top: 1px solid #f0f0f0; padding-top: 10px; display: none; }
  .comment { display: flex; gap: 7px; margin-bottom: 8px; }
  .comment .avatar { width: 26px; height: 26px; font-size: 11px; }
  .comment-author { font-weight: 600; font-size: 12px; }
  .comment-text { font-size: 13px; color: #444; line-height: 1.4; }
  .comment-form { display: flex; gap: 6px; margin-top: 6px; }
  .comment-form input { flex: 1; padding: 7px 9px; border: 1.5px solid #e0e0e0; border-radius: 7px; font-size: 13px; outline: none; }
  .comment-form input:focus { border-color: #222; }
  .comment-form button { padding: 7px 12px; background: #222; color: #fff; border: none; border-radius: 7px; font-size: 12px; cursor: pointer; }

  .lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.9); z-index: 1000; align-items: center; justify-content: center; }
  .lightbox.active { display: flex; }
  .lightbox img { max-width: 95vw; max-height: 95vh; border-radius: 6px; object-fit: contain; }
  .lightbox-close { position: absolute; top: 14px; right: 18px; color: #fff; font-size: 28px; cursor: pointer; background: none; border: none; }

  .loading, .empty { text-align: center; color: #bbb; padding: 30px; font-size: 14px; }
</style>
</head>
<body>

<div id="auth">
  <div class="auth-box">
    <h1>ClosedCircle</h1>
    <p></p>
    <input type="text" id="nameInput" placeholder="–¢–≤–æ—ë –∏–º—è" maxlength="20">
    <input type="password" id="passInput" placeholder="–ü–∞—Ä–æ–ª—å">
    <button onclick="login()">–í–æ–π—Ç–∏</button>
    <div class="auth-error" id="authError"></div>
  </div>
</div>

<div id="app">
  <div class="header">
    <h1>ClosedCircle</h1>
    <div class="header-right">
      <span class="username-badge" id="userBadge"></span>
      <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <div class="create-post">
    <textarea id="postText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
    <div id="mediaPreview" class="media-preview" style="display:none">
      <img id="previewImg" src="">
      <button class="remove-media" onclick="removeMedia()">√ó</button>
    </div>
    <div class="post-actions">
      <label class="upload-btn">
        üì∑ –§–æ—Ç–æ
        <input type="file" id="fileInput" accept="image/*" onchange="uploadFile(this)">
      </label>
      <div class="spacer"></div>
      <button class="post-btn" id="postBtn" onclick="createPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </div>
    <div class="uploading-bar" id="uploadingBar">
      <div class="spinner"></div> –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ...
    </div>
  </div>

  <div class="feed" id="feed">
    <div class="loading">–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å—Ç—ã...</div>
  </div>
</div>

<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <button class="lightbox-close">√ó</button>
  <img id="lightboxImg" src="">
</div>

<script>
const SITE_PASSWORD = '–¥—Ä—É–∑—å—è2024';
const BIN_ID = '699b648443b1c97be99478fb';
const API_KEY = '$2a$10$s4ksLJKYh63TNKFzugR2qeYv9uGvAQ5mPeVYLKx7kwtYNr2pI0iBe';
const CLOUD_NAME = 'dcat5kxgx';
const UPLOAD_PRESET = 'ml_default1111';
const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

let currentUser = null, posts = [], pollInterval = null, uploadedUrl = null;
let isSaving = false; // –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

const colors = ['#e74c3c','#3498db','#2ecc71','#9b59b6','#f39c12','#1abc9c','#e67e22','#34495e'];
function avatarColor(n) { let h=0; for(let c of n) h=(h*31+c.charCodeAt(0))&0xffffffff; return colors[Math.abs(h)%colors.length]; }

function login() {
  const name = document.getElementById('nameInput').value.trim();
  const pass = document.getElementById('passInput').value;
  const err = document.getElementById('authError');
  if (!name) { err.textContent = '–í–≤–µ–¥–∏ —Å–≤–æ—ë –∏–º—è'; return; }
  if (pass !== SITE_PASSWORD) { err.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'; return; }
  currentUser = name;
  document.getElementById('auth').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('userBadge').textContent = name;
  loadPosts();
  pollInterval = setInterval(loadPosts, 12000);
}

function logout() {
  currentUser = null; clearInterval(pollInterval);
  document.getElementById('auth').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  document.getElementById('passInput').value = '';
}

async function fetchData() {
  const r = await fetch(API_URL + '/latest', {
    headers: { 'X-Master-Key': API_KEY }
  });
  if (!r.ok) throw new Error('fetch failed');
  const j = await r.json();
  return j.record && Array.isArray(j.record.posts) ? j.record : { posts: [] };
}

async function saveData(data) {
  const r = await fetch(API_URL, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
    body: JSON.stringify(data)
  });
  if (!r.ok) throw new Error('save failed');
}

// –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ‚Äî —á–∏—Ç–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ, –∏–∑–º–µ–Ω—è–µ–º, —Å–æ—Ö—Ä–∞–Ω—è–µ–º
async function atomicUpdate(updateFn) {
  if (isSaving) return;
  isSaving = true;
  try {
    const data = await fetchData();
    updateFn(data);
    await saveData(data);
    posts = data.posts;
    renderFeed();
  } catch(e) {
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑');
  }
  isSaving = false;
}

async function loadPosts() {
  try {
    const data = await fetchData();
    posts = data.posts || [];
    renderFeed();
  } catch(e) {
    document.getElementById('feed').innerHTML = '<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
  }
}

async function uploadFile(input) {
  const file = input.files[0];
  if (!file) return;
  const bar = document.getElementById('uploadingBar');
  const btn = document.getElementById('postBtn');
  bar.style.display = 'flex';
  btn.disabled = true;
  try {
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', UPLOAD_PRESET);
    const r = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: fd });
    const j = await r.json();
    if (!j.secure_url) throw new Error('no url');
    uploadedUrl = j.secure_url;
    document.getElementById('previewImg').src = uploadedUrl;
    document.getElementById('mediaPreview').style.display = 'block';
  } catch(e) {
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑');
  }
  bar.style.display = 'none';
  btn.disabled = false;
  input.value = '';
}

function removeMedia() {
  uploadedUrl = null;
  document.getElementById('previewImg').src = '';
  document.getElementById('mediaPreview').style.display = 'none';
}

async function createPost() {
  const text = document.getElementById('postText').value.trim();
  if (!text && !uploadedUrl) return;
  const btn = document.getElementById('postBtn');
  btn.disabled = true;
  const newPost = {
    id: Date.now().toString(),
    author: currentUser,
    text,
    media: uploadedUrl || '',
    ts: Date.now(),
    likedBy: [],
    comments: []
  };
  await atomicUpdate(data => {
    data.posts = [newPost, ...(data.posts || [])];
  });
  document.getElementById('postText').value = '';
  removeMedia();
  btn.disabled = false;
}

async function toggleLike(id) {
  await atomicUpdate(data => {
    const post = data.posts.find(p => p.id === id);
    if (!post) return;
    post.likedBy = post.likedBy || [];
    const idx = post.likedBy.indexOf(currentUser);
    if (idx === -1) post.likedBy.push(currentUser);
    else post.likedBy.splice(idx, 1);
  });
}

async function addComment(id) {
  const input = document.getElementById('cinput-' + id);
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  await atomicUpdate(data => {
    const post = data.posts.find(p => p.id === id);
    if (!post) return;
    post.comments = post.comments || [];
    post.comments.push({ author: currentUser, text, ts: Date.now() });
  });
  setTimeout(() => {
    const el = document.getElementById('comments-' + id);
    if (el) el.style.display = 'block';
  }, 50);
}

function timeAgo(ts) {
  const d = (Date.now()-ts)/1000;
  if (d<60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
  if (d<3600) return Math.floor(d/60)+' –º–∏–Ω –Ω–∞–∑–∞–¥';
  if (d<86400) return Math.floor(d/3600)+' —á –Ω–∞–∑–∞–¥';
  return Math.floor(d/86400)+' –¥–Ω –Ω–∞–∑–∞–¥';
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function renderMedia(url) {
  if (!url) return '';
  if (/cloudinary|imgur|\.jpg|\.jpeg|\.png|\.gif|\.webp/i.test(url)) {
    return `<div class="post-media"><img src="${esc(url)}" loading="lazy" onclick="openLightbox('${esc(url)}')"></div>`;
  }
  const yt = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/);
  if (yt) return `<div class="post-media"><iframe src="https://www.youtube.com/embed/${yt[1]}" allowfullscreen></iframe></div>`;
  return `<div class="post-media"><a href="${esc(url)}" target="_blank">üìé ${esc(url)}</a></div>`;
}

function renderFeed() {
  const feed = document.getElementById('feed');
  const openComments = new Set([...document.querySelectorAll('.comments-section')]
    .filter(el => el.style.display === 'block')
    .map(el => el.id.replace('comments-', '')));

  if (!posts.length) { feed.innerHTML = '<div class="empty">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤ üôÇ</div>'; return; }

  feed.innerHTML = [...posts].sort((a,b)=>b.ts-a.ts).map(p => {
    const liked = (p.likedBy||[]).includes(currentUser);
    const col = avatarColor(p.author);
    const commentsHtml = (p.comments||[]).map(c=>`
      <div class="comment">
        <div class="avatar" style="background:${avatarColor(c.author)}">${c.author[0].toUpperCase()}</div>
        <div class="comment-body">
          <div class="comment-author">${esc(c.author)}</div>
          <div class="comment-text">${esc(c.text)}</div>
        </div>
      </div>`).join('');
    const commentsOpen = openComments.has(p.id) ? 'block' : 'none';
    return `
    <div class="post-card" id="post-${p.id}">
      <div class="post-header">
        <div class="avatar" style="background:${col}">${p.author[0].toUpperCase()}</div>
        <div class="post-meta">
          <div class="post-author">${esc(p.author)}</div>
          <div class="post-time">${timeAgo(p.ts)}</div>
        </div>
      </div>
      ${p.text ? `<div class="post-text">${esc(p.text)}</div>` : ''}
      ${renderMedia(p.media)}
      <div class="post-footer">
        <button class="like-btn ${liked?'liked':''}" onclick="toggleLike('${p.id}')">
          ${liked?'‚ù§Ô∏è':'ü§ç'} ${(p.likedBy||[]).length||0}
        </button>
        <button class="comment-toggle" onclick="toggleComments('${p.id}')">
          üí¨ ${(p.comments||[]).length||0}
        </button>
      </div>
      <div class="comments-section" id="comments-${p.id}" style="display:${commentsOpen}">
        ${commentsHtml}
        <div class="comment-form">
          <input placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." id="cinput-${p.id}" onkeydown="if(event.key==='Enter')addComment('${p.id}')">
          <button onclick="addComment('${p.id}')">‚Üí</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function toggleComments(id) {
  const el = document.getElementById('comments-'+id);
  el.style.display = el.style.display==='block' ? 'none' : 'block';
}

function openLightbox(url) {
  document.getElementById('lightboxImg').src = url;
  document.getElementById('lightbox').classList.add('active');
}
function closeLightbox() {
  document.getElementById('lightbox').classList.remove('active');
}
</script>
</body>
</html>