<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clever Simple</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; color: #222; }

  #auth { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #fff; }
  .auth-box { width: 300px; text-align: center; }
  .auth-box h1 { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
  .auth-box p { color: #aaa; font-size: 13px; margin-bottom: 24px; }
  .auth-box input { width: 100%; padding: 10px 12px; border: 1.5px solid #e0e0e0; border-radius: 8px; font-size: 14px; margin-bottom: 8px; outline: none; }
  .auth-box input:focus { border-color: #222; }
  .auth-box button { width: 100%; padding: 10px; background: #222; color: #fff; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; }
  .auth-box button:hover { background: #444; }
  .auth-error { color: #e00; font-size: 12px; margin-top: 6px; min-height: 16px; }

  #app { display: none; max-width: 560px; margin: 0 auto; padding: 16px 12px 60px; }

  .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
  .header h1 { font-size: 18px; font-weight: 700; }
  .header-right { display: flex; align-items: center; gap: 8px; }
  .username-badge { font-size: 12px; background: #f0f0f0; padding: 4px 9px; border-radius: 20px; }
  .logout-btn { font-size: 12px; color: #aaa; background: none; border: none; cursor: pointer; }
  .logout-btn:hover { color: #222; }
  .admin-open-btn { font-size: 12px; background: #222; color: #fff; border: none; border-radius: 6px; padding: 4px 10px; cursor: pointer; }

  .online-bar { font-size: 12px; color: #aaa; margin-bottom: 12px; }
  .online-dot { display: inline-block; width: 7px; height: 7px; background: #2ecc71; border-radius: 50%; margin-right: 4px; }

  .create-post { background: #fff; border-radius: 10px; padding: 12px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.06); }
  .create-post textarea { width: 100%; border: none; outline: none; font-size: 14px; resize: none; font-family: inherit; min-height: 56px; color: #222; }
  .create-post textarea::placeholder { color: #bbb; }
  .muted-notice { font-size: 13px; color: #e00; padding: 8px 0 4px; }

  .media-preview { margin: 8px 0; position: relative; }
  .media-preview img { width: 100%; max-height: 260px; object-fit: cover; border-radius: 8px; display: block; }
  .remove-media { position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,.45); color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 15px; display: flex; align-items: center; justify-content: center; }

  .post-actions { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
  .upload-btn { display: flex; align-items: center; gap: 5px; padding: 6px 12px; background: #f5f5f5; border: none; border-radius: 7px; font-size: 13px; cursor: pointer; color: #555; }
  .upload-btn:hover { background: #eee; }
  .upload-btn input { display: none; }
  .spacer { flex: 1; }
  .post-btn { padding: 6px 16px; background: #222; color: #fff; border: none; border-radius: 7px; font-size: 13px; cursor: pointer; }
  .post-btn:hover { background: #444; }
  .post-btn:disabled { background: #bbb; cursor: not-allowed; }

  .uploading-bar { margin-top: 6px; font-size: 12px; color: #888; display: none; align-items: center; gap: 6px; }
  .spinner { width: 12px; height: 12px; border: 2px solid #ddd; border-top-color: #222; border-radius: 50%; animation: spin .6s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .feed { display: flex; flex-direction: column; gap: 10px; }
  .post-card { background: #fff; border-radius: 10px; padding: 14px; box-shadow: 0 1px 2px rgba(0,0,0,.06); position: relative; }
  .post-card.pinned { border-left: 3px solid #222; }
  .pinned-label { font-size: 11px; color: #aaa; margin-bottom: 8px; }
  .post-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
  .avatar { width: 32px; height: 32px; border-radius: 50%; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; flex-shrink: 0; }
  .post-meta { flex: 1; min-width: 0; }
  .post-author-row { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
  .post-author { font-weight: 600; font-size: 13px; }
  .grad { background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .user-tag { font-size: 10px; padding: 1px 6px; border-radius: 10px; background: #f0f0f0; color: #666; font-weight: 500; }
  .post-time { font-size: 11px; color: #bbb; }
  .last-seen { font-size: 11px; color: #bbb; }
  .online-badge { font-size: 10px; color: #2ecc71; font-weight: 500; }
  .post-text { font-size: 14px; line-height: 1.5; margin-bottom: 10px; white-space: pre-wrap; word-break: break-word; }
  .post-media { margin-bottom: 10px; }
  .post-media img { width: 100%; display: block; max-height: 380px; object-fit: cover; border-radius: 8px; cursor: pointer; }
  .post-media iframe { width: 100%; height: 280px; border: none; border-radius: 8px; }
  .post-footer { display: flex; align-items: center; gap: 10px; }
  .like-btn, .comment-toggle { display: flex; align-items: center; gap: 4px; background: none; border: none; cursor: pointer; font-size: 13px; color: #aaa; padding: 3px 7px; border-radius: 7px; }
  .like-btn:hover, .comment-toggle:hover { background: #f5f5f5; color: #666; }
  .like-btn.liked { color: #e00; }

  .comments-section { margin-top: 10px; border-top: 1px solid #f0f0f0; padding-top: 10px; display: none; }
  .comment { display: flex; gap: 7px; margin-bottom: 8px; align-items: flex-start; }
  .comment .avatar { width: 26px; height: 26px; font-size: 11px; }
  .comment-author { font-weight: 600; font-size: 12px; }
  .comment-text { font-size: 13px; color: #444; line-height: 1.4; }
  .comment-form { display: flex; gap: 6px; margin-top: 6px; }
  .comment-form input { flex: 1; padding: 7px 9px; border: 1.5px solid #e0e0e0; border-radius: 7px; font-size: 13px; outline: none; }
  .comment-form input:focus { border-color: #222; }
  .comment-form button { padding: 7px 12px; background: #222; color: #fff; border: none; border-radius: 7px; font-size: 12px; cursor: pointer; }

  /* ADMIN PANEL */
  #adminPanel { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 500; align-items: flex-start; justify-content: center; overflow-y: auto; padding: 20px 12px; }
  #adminPanel.open { display: flex; }
  .admin-box { background: #fff; border-radius: 14px; width: 100%; max-width: 540px; padding: 20px; margin: auto; }
  .admin-box h2 { font-size: 17px; font-weight: 700; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
  .admin-close { background: none; border: none; font-size: 22px; cursor: pointer; color: #aaa; }
  .admin-tabs { display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap; }
  .admin-tab { padding: 6px 14px; border: 1.5px solid #e0e0e0; border-radius: 20px; font-size: 13px; cursor: pointer; background: #fff; }
  .admin-tab.active { background: #222; color: #fff; border-color: #222; }
  .admin-section { display: none; }
  .admin-section.active { display: block; }

  .admin-post { background: #f9f9f9; border-radius: 8px; padding: 10px; margin-bottom: 8px; }
  .admin-post-author { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
  .admin-post-text { font-size: 13px; color: #555; margin-bottom: 8px; white-space: pre-wrap; word-break: break-word; max-height: 60px; overflow: hidden; }
  .admin-post-actions { display: flex; gap: 6px; flex-wrap: wrap; }
  .abtn { padding: 5px 10px; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; }
  .abtn-red { background: #fee; color: #c00; }
  .abtn-red:hover { background: #fcc; }
  .abtn-blue { background: #e8f0fe; color: #1a56db; }
  .abtn-blue:hover { background: #c7d7fc; }
  .abtn-green { background: #e6f9f0; color: #1a7a4a; }
  .abtn-green:hover { background: #b8f0d4; }
  .abtn-gray { background: #f0f0f0; color: #555; }
  .abtn-gray:hover { background: #e0e0e0; }

  .admin-user { background: #f9f9f9; border-radius: 8px; padding: 10px; margin-bottom: 8px; }
  .admin-user-name { font-weight: 600; font-size: 13px; margin-bottom: 8px; }
  .admin-user-actions { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px; }
  .admin-input { width: 100%; padding: 7px 9px; border: 1.5px solid #e0e0e0; border-radius: 7px; font-size: 13px; outline: none; margin-bottom: 6px; }
  .admin-input:focus { border-color: #222; }
  .color-row { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; flex-wrap: wrap; }
  .color-row label { font-size: 12px; color: #666; }
  .color-row input[type=color] { width: 32px; height: 28px; border: none; border-radius: 6px; cursor: pointer; padding: 0; }
  .color-row input[type=checkbox] { cursor: pointer; }

  .admin-likes-row { display: flex; gap: 6px; align-items: center; margin-top: 6px; }
  .admin-likes-row input { width: 60px; padding: 5px 8px; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 13px; outline: none; }

  .edit-textarea { width: 100%; padding: 7px 9px; border: 1.5px solid #e0e0e0; border-radius: 7px; font-size: 13px; outline: none; resize: vertical; min-height: 60px; margin-bottom: 6px; font-family: inherit; }

  .comment-item { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; padding: 6px 0; border-bottom: 1px solid #f0f0f0; }
  .comment-item:last-child { border-bottom: none; }
  .comment-item-text { font-size: 12px; color: #444; flex: 1; }
  .comment-item-author { font-weight: 600; }

  .lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.9); z-index: 1000; align-items: center; justify-content: center; }
  .lightbox.active { display: flex; }
  .lightbox img { max-width: 95vw; max-height: 95vh; border-radius: 6px; object-fit: contain; }
  .lightbox-close { position: absolute; top: 14px; right: 18px; color: #fff; font-size: 28px; cursor: pointer; background: none; border: none; }

  .loading, .empty { text-align: center; color: #bbb; padding: 30px; font-size: 14px; }
  .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #222; color: #fff; padding: 9px 18px; border-radius: 20px; font-size: 13px; opacity: 0; transition: opacity .3s; pointer-events: none; z-index: 2000; white-space: nowrap; }
  .toast.show { opacity: 1; }
</style>
</head>
<body>

<div id="auth">
  <div class="auth-box">
    <h1>Clever Simple</h1>
    <p></p>
    <input type="text" id="nameInput" placeholder="–¢–≤–æ—ë –∏–º—è" maxlength="20">
    <input type="password" id="passInput" placeholder="–ü–∞—Ä–æ–ª—å">
    <button onclick="login()">–í–æ–π—Ç–∏</button>
    <div class="auth-error" id="authError"></div>
  </div>
</div>

<div id="app">
  <div class="header">
    <h1>Clever Simple</h1>
    <div class="header-right">
      <span class="username-badge" id="userBadge"></span>
      <button class="admin-open-btn" id="adminOpenBtn" style="display:none" onclick="openAdmin()">‚öôÔ∏è –ê–¥–º–∏–Ω</button>
      <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <div class="online-bar" id="onlineBar"></div>

  <div class="create-post" id="createPost">
    <textarea id="postText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
    <div id="mediaPreview" class="media-preview" style="display:none">
      <img id="previewImg" src="">
      <button class="remove-media" onclick="removeMedia()">√ó</button>
    </div>
    <div class="post-actions">
      <label class="upload-btn">
        –§–æ—Ç–æ
        <input type="file" id="fileInput" accept="image/*" onchange="uploadFile(this)">
      </label>
      <div class="spacer"></div>
      <button class="post-btn" id="postBtn" onclick="createPost()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    <div class="uploading-bar" id="uploadingBar">
      <div class="spinner"></div> –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ...
    </div>
  </div>

  <div class="feed" id="feed">
    <div class="loading">–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å—Ç—ã...</div>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel">
  <div class="admin-box">
    <h2>‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å <button class="admin-close" onclick="closeAdmin()">√ó</button></h2>
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="adminTab('posts')">–ü–æ—Å—Ç—ã</button>
      <button class="admin-tab" onclick="adminTab('users')">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
      <button class="admin-tab" onclick="adminTab('admins')">–ê–¥–º–∏–Ω—ã</button>
    </div>

    <!-- POSTS -->
    <div class="admin-section active" id="atab-posts">
      <div id="adminPostsList"></div>
    </div>

    <!-- USERS -->
    <div class="admin-section" id="atab-users">
      <div id="adminUsersList"></div>
    </div>

    <!-- ADMINS -->
    <div class="admin-section" id="atab-admins">
      <p style="font-size:13px;color:#888;margin-bottom:10px">–í–≤–µ–¥–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á—Ç–æ–±—ã –≤—ã–¥–∞—Ç—å –∏–ª–∏ –∑–∞–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞</p>
      <input class="admin-input" id="adminGrantInput" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
      <div style="display:flex;gap:8px">
        <button class="abtn abtn-green" onclick="grantAdmin()">–í—ã–¥–∞—Ç—å –ø—Ä–∞–≤–∞</button>
        <button class="abtn abtn-red" onclick="revokeAdmin()">–ó–∞–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∞</button>
      </div>
      <div id="adminList" style="margin-top:14px;font-size:13px;color:#555"></div>
    </div>
  </div>
</div>

<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <button class="lightbox-close">√ó</button>
  <img id="lightboxImg" src="">
</div>
<div class="toast" id="toast"></div>

<script>
const SITE_PASSWORD = '1111';
const ADMIN_PASSWORD = '1234';
const SUPER_ADMIN = '–ì–ª–µ–±';
const SUPABASE_URL = 'https://thxoijrdzjylijkgkhev.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRoeG9panJkemp5bGlqa2draGV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MzI1ODcsImV4cCI6MjA4NzQwODU4N30.CgQfwVniCIQTebqEAG7toh0L--w4OrJ_yULn1sz5OQE';
const CLOUD_NAME = 'dcat5kxgx';
const UPLOAD_PRESET = 'ml_default1111';
const POSTS_API = `${SUPABASE_URL}/rest/v1/posts`;
const USERS_API = `${SUPABASE_URL}/rest/v1/users`;
const H = {
  'apikey': SUPABASE_KEY,
  'Authorization': `Bearer ${SUPABASE_KEY}`,
  'Content-Type': 'application/json',
  'Prefer': 'return=representation'
};

let currentUser = null, posts = [], users = {}, pollInterval = null, uploadedUrl = null, isAdmin = false;

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
const colors = ['#e74c3c','#3498db','#2ecc71','#9b59b6','#f39c12','#1abc9c','#e67e22','#34495e'];
function avatarColor(n) { let h=0; for(let c of n) h=(h*31+c.charCodeAt(0))&0xffffffff; return colors[Math.abs(h)%colors.length]; }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2500);
}
function timeAgo(ts) {
  const d = (Date.now()-ts)/1000;
  if (d<60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
  if (d<3600) return Math.floor(d/60)+' –º–∏–Ω –Ω–∞–∑–∞–¥';
  if (d<86400) return Math.floor(d/3600)+' —á –Ω–∞–∑–∞–¥';
  return Math.floor(d/86400)+' –¥–Ω –Ω–∞–∑–∞–¥';
}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
async function login() {
  const name = document.getElementById('nameInput').value.trim();
  const pass = document.getElementById('passInput').value;
  const err = document.getElementById('authError');
  if (!name) { err.textContent = '–í–≤–µ–¥–∏ —Å–≤–æ—ë –∏–º—è'; return; }
  if (pass !== SITE_PASSWORD && pass !== ADMIN_PASSWORD) { err.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'; return; }
  isAdmin = (pass === ADMIN_PASSWORD) || name === SUPER_ADMIN;
  currentUser = name;
  document.getElementById('auth').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('userBadge').textContent = name;
  if (isAdmin) document.getElementById('adminOpenBtn').style.display = 'inline-block';
  await upsertUser(name);
  await loadAll();
  startPolling();
  startHeartbeat();
}

function logout() {
  currentUser = null; isAdmin = false;
  clearInterval(pollInterval);
  document.getElementById('auth').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  document.getElementById('passInput').value = '';
  document.getElementById('adminOpenBtn').style.display = 'none';
}

// ‚îÄ‚îÄ HEARTBEAT (–æ–Ω–ª–∞–π–Ω) ‚îÄ‚îÄ
function startHeartbeat() {
  updateLastSeen();
  setInterval(updateLastSeen, 30000);
}
async function updateLastSeen() {
  await fetch(`${USERS_API}?username=eq.${encodeURIComponent(currentUser)}`, {
    method: 'PATCH', headers: H,
    body: JSON.stringify({ last_seen: Date.now() })
  });
}

// ‚îÄ‚îÄ SUPABASE HELPERS ‚îÄ‚îÄ
async function upsertUser(name) {
  const r = await fetch(`${USERS_API}?username=eq.${encodeURIComponent(name)}`, { headers: H });
  const existing = await r.json();
  if (!existing.length) {
    const isSuper = name === SUPER_ADMIN;
    await fetch(USERS_API, {
      method: 'POST', headers: H,
      body: JSON.stringify({ username: name, display_name: name, tag: '', color: '', color2: '', is_admin: isSuper, is_muted: false, last_seen: Date.now() })
    });
  }
}

async function loadUsers() {
  const r = await fetch(USERS_API, { headers: H });
  const arr = await r.json();
  users = {};
  arr.forEach(u => users[u.username] = u);
  // check if current user became admin
  if (users[currentUser] && users[currentUser].is_admin) {
    isAdmin = true;
    document.getElementById('adminOpenBtn').style.display = 'inline-block';
  }
}

async function loadPosts() {
  const r = await fetch(POSTS_API + '?order=ts.desc', { headers: H });
  if (!r.ok) return;
  posts = await r.json();
}

async function loadAll() {
  await Promise.all([loadPosts(), loadUsers()]);
  renderFeed();
  renderOnline();
}

function startPolling() {
  pollInterval = setInterval(loadAll, 10000);
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) clearInterval(pollInterval);
    else { loadAll(); pollInterval = setInterval(loadAll, 10000); }
  });
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function getNameHtml(username) {
  const u = users[username];
  if (!u) return `<span class="post-author">${esc(username)}</span>`;
  const name = esc(u.display_name || username);
  let authorHtml;
  if (u.color && u.color2) {
    authorHtml = `<span class="post-author grad" style="background:linear-gradient(90deg,${u.color},${u.color2})">${name}</span>`;
  } else if (u.color) {
    authorHtml = `<span class="post-author" style="color:${u.color}">${name}</span>`;
  } else {
    authorHtml = `<span class="post-author">${name}</span>`;
  }
  const tagHtml = u.tag ? `<span class="user-tag">${esc(u.tag)}</span>` : '';
  return authorHtml + tagHtml;
}

function getOnlineStatus(username) {
  const u = users[username];
  if (!u || !u.last_seen) return '';
  const diff = (Date.now() - u.last_seen) / 1000;
  if (diff < 90) return `<span class="online-badge">‚óè –≤ —Å–µ—Ç–∏</span>`;
  if (diff < 3600) return `<span class="last-seen">${Math.floor(diff/60)} –º–∏–Ω –Ω–∞–∑–∞–¥</span>`;
  if (diff < 86400) return `<span class="last-seen">${Math.floor(diff/3600)} —á –Ω–∞–∑–∞–¥</span>`;
  return `<span class="last-seen">${Math.floor(diff/86400)} –¥–Ω –Ω–∞–∑–∞–¥</span>`;
}

function renderOnline() {
  const now = Date.now();
  const onlineUsers = Object.values(users).filter(u => u.last_seen && (now - u.last_seen) < 90000);
  const bar = document.getElementById('onlineBar');
  if (!onlineUsers.length) { bar.innerHTML = ''; return; }
  bar.innerHTML = `<span class="online-dot"></span> –û–Ω–ª–∞–π–Ω: ${onlineUsers.length} ‚Äî ${onlineUsers.map(u=>esc(u.display_name||u.username)).join(', ')}`;
}

function renderMedia(url) {
  if (!url) return '';
  if (/cloudinary|imgur|\.jpg|\.jpeg|\.png|\.gif|\.webp/i.test(url))
    return `<div class="post-media"><img src="${esc(url)}" loading="lazy" onclick="openLightbox('${esc(url)}')"></div>`;
  const yt = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/);
  if (yt) return `<div class="post-media"><iframe src="https://www.youtube.com/embed/${yt[1]}" allowfullscreen></iframe></div>`;
  return `<div class="post-media"><a href="${esc(url)}" target="_blank">üìé ${esc(url)}</a></div>`;
}

function renderFeed() {
  const feed = document.getElementById('feed');
  const openComments = new Set([...document.querySelectorAll('.comments-section')]
    .filter(el => el.style.display==='block').map(el => el.id.replace('comments-','')));

  // check muted
  const me = users[currentUser];
  const cp = document.getElementById('createPost');
  if (me && me.is_muted) {
    cp.innerHTML = '<div class="muted-notice">üîá –¢—ã –∑–∞–º—É—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∏ –Ω–µ –º–æ–∂–µ—à—å –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç—ã</div>';
  }

  if (!posts.length) { feed.innerHTML = '<div class="empty">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤</div>'; return; }

  const pinned = posts.filter(p=>p.pinned);
  const normal = posts.filter(p=>!p.pinned);
  const sorted = [...pinned, ...normal];

  feed.innerHTML = sorted.map(p => {
    const liked = (p.liked_by||[]).includes(currentUser);
    const col = avatarColor(p.author);
    const u = users[p.author] || {};
    const avatarLetter = (u.display_name || p.author)[0].toUpperCase();
    const commentsHtml = (p.comments||[]).map((c,ci)=>`
      <div class="comment">
        <div class="avatar" style="background:${avatarColor(c.author)}">${((users[c.author]||{}).display_name||c.author)[0].toUpperCase()}</div>
        <div class="comment-body" style="flex:1">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span class="comment-author">${esc((users[c.author]||{}).display_name||c.author)}</span>
            ${isAdmin ? `<button onclick="deleteComment('${p.id}',${ci})" style="background:none;border:none;cursor:pointer;font-size:11px;color:#ccc">‚úï</button>` : ''}
          </div>
          <div class="comment-text">${esc(c.text)}</div>
        </div>
      </div>`).join('');
    return `
    <div class="post-card${p.pinned?' pinned':''}" id="post-${p.id}">
      ${p.pinned ? '<div class="pinned-label">üìå –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ</div>' : ''}
      <div class="post-header">
        <div class="avatar" style="background:${col}">${avatarLetter}</div>
        <div class="post-meta">
          <div class="post-author-row">${getNameHtml(p.author)} ${getOnlineStatus(p.author)}</div>
          <div class="post-time">${timeAgo(p.ts)}</div>
        </div>
      </div>
      ${p.text ? `<div class="post-text">${esc(p.text)}</div>` : ''}
      ${renderMedia(p.media||'')}
      <div class="post-footer">
        <button class="like-btn ${liked?'liked':''}" onclick="toggleLike('${p.id}')">
          ${liked?'‚ù§Ô∏è':'ü§ç'} ${(p.liked_by||[]).length||0}
        </button>
        <button class="comment-toggle" onclick="toggleComments('${p.id}')">
          üí¨ ${(p.comments||[]).length||0}
        </button>
      </div>
      <div class="comments-section" id="comments-${p.id}" style="display:${openComments.has(p.id)?'block':'none'}">
        ${commentsHtml}
        <div class="comment-form">
          <input placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." id="cinput-${p.id}" onkeydown="if(event.key==='Enter')addComment('${p.id}')">
          <button onclick="addComment('${p.id}')">‚Üí</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ POST ACTIONS ‚îÄ‚îÄ
async function createPost() {
  const me = users[currentUser];
  if (me && me.is_muted) { toast('–¢—ã –∑–∞–º—É—á–µ–Ω'); return; }
  const text = document.getElementById('postText').value.trim();
  if (!text && !uploadedUrl) return;
  const btn = document.getElementById('postBtn');
  btn.disabled = true;
  try {
    await fetch(POSTS_API, {
      method: 'POST', headers: H,
      body: JSON.stringify({ id: Date.now().toString(), author: currentUser, text, media: uploadedUrl||'', ts: Date.now(), liked_by: [], comments: [], pinned: false })
    });
    document.getElementById('postText').value = '';
    removeMedia();
    await loadAll();
  } catch(e) { toast('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏'); }
  btn.disabled = false;
}

async function toggleLike(id) {
  const post = posts.find(p=>p.id===id);
  if (!post) return;
  const liked_by = [...(post.liked_by||[])];
  const idx = liked_by.indexOf(currentUser);
  if (idx===-1) liked_by.push(currentUser); else liked_by.splice(idx,1);
  await fetch(`${POSTS_API}?id=eq.${id}`, { method:'PATCH', headers:H, body:JSON.stringify({liked_by}) });
  await loadAll();
}

async function addComment(id) {
  const input = document.getElementById('cinput-'+id);
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  const post = posts.find(p=>p.id===id);
  if (!post) return;
  const comments = [...(post.comments||[]), {author:currentUser, text, ts:Date.now()}];
  await fetch(`${POSTS_API}?id=eq.${id}`, { method:'PATCH', headers:H, body:JSON.stringify({comments}) });
  await loadAll();
  setTimeout(()=>{ const el=document.getElementById('comments-'+id); if(el) el.style.display='block'; },50);
}

async function deleteComment(postId, idx) {
  const post = posts.find(p=>p.id===postId);
  if (!post) return;
  const comments = [...(post.comments||[])];
  comments.splice(idx,1);
  await fetch(`${POSTS_API}?id=eq.${postId}`, { method:'PATCH', headers:H, body:JSON.stringify({comments}) });
  await loadAll();
  toast('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–¥–∞–ª—ë–Ω');
}

async function uploadFile(input) {
  const file = input.files[0]; if (!file) return;
  const bar = document.getElementById('uploadingBar'), btn = document.getElementById('postBtn');
  bar.style.display = 'flex'; btn.disabled = true;
  try {
    const fd = new FormData();
    fd.append('file', file); fd.append('upload_preset', UPLOAD_PRESET);
    const r = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {method:'POST',body:fd});
    const j = await r.json();
    if (!j.secure_url) throw new Error();
    uploadedUrl = j.secure_url;
    document.getElementById('previewImg').src = uploadedUrl;
    document.getElementById('mediaPreview').style.display = 'block';
  } catch(e) { toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ'); }
  bar.style.display = 'none'; btn.disabled = false; input.value = '';
}

function removeMedia() {
  uploadedUrl = null;
  document.getElementById('previewImg').src = '';
  document.getElementById('mediaPreview').style.display = 'none';
}

function toggleComments(id) {
  const el = document.getElementById('comments-'+id);
  el.style.display = el.style.display==='block' ? 'none' : 'block';
}

// ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ
function openAdmin() {
  document.getElementById('adminPanel').classList.add('open');
  renderAdminPosts();
}
function closeAdmin() { document.getElementById('adminPanel').classList.remove('open'); }

function adminTab(name) {
  document.querySelectorAll('.admin-tab').forEach((t,i)=>t.classList.toggle('active', ['posts','users','admins'][i]===name));
  document.querySelectorAll('.admin-section').forEach(s=>s.classList.remove('active'));
  document.getElementById('atab-'+name).classList.add('active');
  if (name==='posts') renderAdminPosts();
  if (name==='users') renderAdminUsers();
  if (name==='admins') renderAdminList();
}

function renderAdminPosts() {
  const el = document.getElementById('adminPostsList');
  if (!posts.length) { el.innerHTML = '<div class="empty">–ù–µ—Ç –ø–æ—Å—Ç–æ–≤</div>'; return; }
  el.innerHTML = [...posts].sort((a,b)=>b.ts-a.ts).map(p => {
    const preview = (p.text||'').slice(0,80) + ((p.text||'').length>80?'...':'');
    return `<div class="admin-post">
      <div class="admin-post-author">${esc(p.author)} ¬∑ ${timeAgo(p.ts)}</div>
      <div class="admin-post-text">${esc(preview) || 'üì∑ —Ñ–æ—Ç–æ'}</div>
      <div class="admin-post-actions">
        <button class="abtn abtn-red" onclick="adminDeletePost('${p.id}')">üóë –£–¥–∞–ª–∏—Ç—å</button>
        <button class="abtn abtn-blue" onclick="adminTogglePin('${p.id}',${!!p.pinned})">${p.pinned?'üìå –û—Ç–∫—Ä–µ–ø–∏—Ç—å':'üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å'}</button>
        <button class="abtn abtn-gray" onclick="adminEditPost('${p.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <div id="edit-${p.id}" style="display:none;margin-top:8px">
        <textarea class="edit-textarea" id="edittext-${p.id}">${esc(p.text||'')}</textarea>
        <div class="admin-likes-row">
          <label style="font-size:12px">–õ–∞–π–∫–æ–≤:</label>
          <input type="number" id="editlikes-${p.id}" value="${(p.liked_by||[]).length}" min="0">
          <button class="abtn abtn-green" onclick="adminSavePost('${p.id}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function adminEditPost(id) {
  const el = document.getElementById('edit-'+id);
  el.style.display = el.style.display==='none' ? 'block' : 'none';
}

async function adminSavePost(id) {
  const post = posts.find(p=>p.id===id);
  if (!post) return;
  const text = document.getElementById('edittext-'+id).value;
  const likesCount = parseInt(document.getElementById('editlikes-'+id).value)||0;
  const liked_by = [...(post.liked_by||[])];
  // adjust liked_by array length
  while (liked_by.length < likesCount) liked_by.push('__fake__'+liked_by.length);
  while (liked_by.length > likesCount) liked_by.pop();
  await fetch(`${POSTS_API}?id=eq.${id}`, { method:'PATCH', headers:H, body:JSON.stringify({text, liked_by}) });
  await loadAll();
  renderAdminPosts();
  toast('–ü–æ—Å—Ç –æ–±–Ω–æ–≤–ª—ë–Ω');
}

async function adminDeletePost(id) {
  await fetch(`${POSTS_API}?id=eq.${id}`, { method:'DELETE', headers:H });
  await loadAll();
  renderAdminPosts();
  toast('–ü–æ—Å—Ç —É–¥–∞–ª—ë–Ω');
}

async function adminTogglePin(id, isPinned) {
  await fetch(`${POSTS_API}?id=eq.${id}`, { method:'PATCH', headers:H, body:JSON.stringify({pinned:!isPinned}) });
  await loadAll();
  renderAdminPosts();
  toast(isPinned ? '–ü–æ—Å—Ç –æ—Ç–∫—Ä–µ–ø–ª—ë–Ω' : '–ü–æ—Å—Ç –∑–∞–∫—Ä–µ–ø–ª—ë–Ω');
}

function renderAdminUsers() {
  const el = document.getElementById('adminUsersList');
  const list = Object.values(users);
  if (!list.length) { el.innerHTML = '<div class="empty">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>'; return; }
  el.innerHTML = list.map(u => `
    <div class="admin-user" id="auser-${u.username}">
      <div class="admin-user-name">${esc(u.display_name||u.username)} ${u.is_muted?'üîá':''} ${u.is_admin?'üëë':''}</div>
      <div class="admin-user-actions">
        <button class="abtn ${u.is_muted?'abtn-green':'abtn-red'}" onclick="adminToggleMute('${u.username}',${u.is_muted})">
          ${u.is_muted?'üîä –†–∞–∑–º—É—Ç–∏—Ç—å':'üîá –ó–∞–º—É—Ç–∏—Ç—å'}
        </button>
        <button class="abtn abtn-gray" onclick="adminToggleUserEdit('${u.username}')">üé® –°—Ç–∏–ª—å</button>
      </div>
      <div id="uedit-${u.username}" style="display:none;margin-top:8px">
        <input class="admin-input" id="udname-${u.username}" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è" value="${esc(u.display_name||u.username)}">
        <input class="admin-input" id="utag-${u.username}" placeholder="–¢–µ–≥ (–Ω–∞–ø—Ä. Admin, VIP, üåü)" value="${esc(u.tag||'')}">
        <div class="color-row">
          <label>–¶–≤–µ—Ç –Ω–∏–∫–∞:</label>
          <input type="color" id="ucol1-${u.username}" value="${u.color||'#222222'}">
          <label>–ì—Ä–∞–¥–∏–µ–Ω—Ç (2–π —Ü–≤–µ—Ç):</label>
          <input type="color" id="ucol2-${u.username}" value="${u.color2||'#e74c3c'}">
          <label><input type="checkbox" id="ugrad-${u.username}" ${u.color2?'checked':''}> –≤–∫–ª</label>
        </div>
        <button class="abtn abtn-green" onclick="adminSaveUser('${u.username}')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="abtn abtn-gray" onclick="adminResetUser('${u.username}')" style="margin-left:4px">–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∏–ª—å</button>
      </div>
    </div>`).join('');
}

function adminToggleUserEdit(username) {
  const el = document.getElementById('uedit-'+username);
  el.style.display = el.style.display==='none' ? 'block' : 'none';
}

async function adminToggleMute(username, isMuted) {
  await fetch(`${USERS_API}?username=eq.${encodeURIComponent(username)}`, {
    method:'PATCH', headers:H, body:JSON.stringify({is_muted:!isMuted})
  });
  await loadUsers();
  renderAdminUsers();
  toast(isMuted ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–º—É—á–µ–Ω' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–º—É—á–µ–Ω');
}

async function adminSaveUser(username) {
  const dname = document.getElementById('udname-'+username).value.trim();
  const tag = document.getElementById('utag-'+username).value.trim();
  const col1 = document.getElementById('ucol1-'+username).value;
  const grad = document.getElementById('ugrad-'+username).checked;
  const col2 = grad ? document.getElementById('ucol2-'+username).value : '';
  await fetch(`${USERS_API}?username=eq.${encodeURIComponent(username)}`, {
    method:'PATCH', headers:H,
    body:JSON.stringify({ display_name: dname||username, tag, color: col1, color2: col2 })
  });
  await loadAll();
  renderAdminUsers();
  toast('–°—Ç–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
}

async function adminResetUser(username) {
  await fetch(`${USERS_API}?username=eq.${encodeURIComponent(username)}`, {
    method:'PATCH', headers:H,
    body:JSON.stringify({ display_name: username, tag:'', color:'', color2:'' })
  });
  await loadAll();
  renderAdminUsers();
  toast('–°—Ç–∏–ª—å —Å–±—Ä–æ—à–µ–Ω');
}

async function grantAdmin() {
  const name = document.getElementById('adminGrantInput').value.trim();
  if (!name) return;
  await fetch(`${USERS_API}?username=eq.${encodeURIComponent(name)}`, {
    method:'PATCH', headers:H, body:JSON.stringify({is_admin:true})
  });
  await loadUsers();
  renderAdminList();
  toast('–ü—Ä–∞–≤–∞ –≤—ã–¥–∞–Ω—ã: '+name);
}

async function revokeAdmin() {
  const name = document.getElementById('adminGrantInput').value.trim();
  if (!name || name===SUPER_ADMIN) { toast('–ù–µ–ª—å–∑—è –∑–∞–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∞ —É –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞'); return; }
  await fetch(`${USERS_API}?username=eq.${encodeURIComponent(name)}`, {
    method:'PATCH', headers:H, body:JSON.stringify({is_admin:false})
  });
  await loadUsers();
  renderAdminList();
  toast('–ü—Ä–∞–≤–∞ –∑–∞–±—Ä–∞–Ω—ã: '+name);
}

function renderAdminList() {
  const admins = Object.values(users).filter(u=>u.is_admin);
  document.getElementById('adminList').innerHTML = admins.length
    ? '<b>–¢–µ–∫—É—â–∏–µ –∞–¥–º–∏–Ω—ã:</b> ' + admins.map(u=>esc(u.display_name||u.username)).join(', ')
    : '–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –∞–¥–º–∏–Ω–æ–≤';
}

// ‚îÄ‚îÄ LIGHTBOX ‚îÄ‚îÄ
function openLightbox(url) { document.getElementById('lightboxImg').src=url; document.getElementById('lightbox').classList.add('active'); }
function closeLightbox() { document.getElementById('lightbox').classList.remove('active'); }
</script>
</body>
</html>